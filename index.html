<!DOCTYPE html>
<html>
<head>
    <title>Chocogram</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --tg-blue: #2481cc; --tg-bg: #e7ebf0; --panel: #fff; --text: #000; --bubble-sent: #effdde; }
        .dark-mode { --tg-blue: #1c242f; --tg-bg: #0e1621; --panel: #17212b; --text: #fff; --bubble-sent: #2b5278; }
        body { font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: var(--tg-bg); color: var(--text); }
        #left-pane { width: 320px; background: var(--panel); border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .pane-header { background: var(--tg-blue); padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; position: relative; }
        .menu-btn { cursor: pointer; font-size: 22px; padding: 5px; }
        .dropdown-menu { position: absolute; right: 10px; top: 50px; background: white; color: black; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); display: none; z-index: 100; min-width: 170px; }
        .dropdown-menu div { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
        .dropdown-menu div:hover { background: #f1f1f1; }
        #chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; border: 1px solid #ddd; }
        #right-pane { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        #chat-header { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px; }
        #messages { flex: 1; overflow-y: scroll; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 12px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .sent { align-self: flex-end; background: var(--bubble-sent); color: #000; }
        .received { align-self: flex-start; background: #fff; color: #000; }
        .input-area { background: var(--panel); padding: 10px 20px; display: flex; gap: 10px; align-items: center; }
        #msgInput { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px; outline: none; background: var(--tg-bg); color: var(--text); }
        #infoModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 12px; box-shadow: 0 0 30px rgba(0,0,0,0.4); z-index: 1001; text-align: center; color: #333; width: 250px; }
        #modalOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
    </style>
</head>
<body>
<div id="modalOverlay" onclick="closeModal()"></div>
<div id="infoModal">
    <img id="infoAv" src="" style="width:100px; height:100px; border-radius:50%; margin-bottom:15px; border: 2px solid var(--tg-blue);">
    <h2 id="infoName">User</h2><p id="infoDate"></p>
    <button onclick="closeModal()" style="background:var(--tg-blue); color:white; border:none; padding:10px; width:100%; cursor:pointer;">Close</button>
</div>
<div id="left-pane">
    <div class="pane-header">
        <span id="uNameDisplay">Telegram</span>
        <div class="menu-btn" onclick="toggleMenu()">â‹®</div>
        <div class="dropdown-menu" id="mainMenu">
            <div onclick="changeTheme()">ðŸŒ“ Change Theme</div>
            <div onclick="location.href='/ai-generator'">ðŸŽ¨ AI Image Generator</div>
            <div onclick="location.href='/logout'" style="color: red;">ðŸšª Logout & Clear</div>
        </div>
    </div>
    <input type="text" id="searchBar" onkeyup="searchUsers()" placeholder="Search..." style="margin:10px; padding:10px; border-radius:20px; border: 1px solid #ddd;">
    <div id="chat-list"></div>
</div>
<div id="right-pane">
    <div id="chat-header" style="display:none;">
        <img id="targetAv" class="avatar" style="width:40px; height:40px; cursor:pointer;" onclick="showUserInfo()">
        <span id="chattingWithName">User</span>
    </div>
    <div id="messages"></div>
    <div class="input-area" id="inputArea" style="display:none;">
        <button onclick="document.getElementById('fIn').click()">ðŸ“Ž</button>
        <input type="file" id="fIn" style="display:none" onchange="uploadFile()">
        <input type="text" id="msgInput" placeholder="Write a message...">
        <button onclick="sendMsg()" style="color:var(--tg-blue); background:none; border:none; font-size:20px; cursor:pointer;">âž¤</button>
    </div>
</div>

<link rel="manifest" href="/manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js')
      .then(() => console.log("Service Worker Registered"));
  }
</script>

<script>
    const socket = io();
    let myName = "", targetUser = "";
    fetch('/get-session').then(r => r.json()).then(d => {
        if(d.user) { myName = d.user.name; document.getElementById('uNameDisplay').innerText = myName; socket.emit('join-private', myName); }
    });
    function toggleMenu() { const m = document.getElementById('mainMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
    function changeTheme() { document.body.classList.toggle('dark-mode'); toggleMenu(); }
    async function searchUsers() {
        const res = await fetch(`/search-user?username=${document.getElementById('searchBar').value}`);
        const users = await res.json();
        const list = document.getElementById('chat-list'); list.innerHTML = '';
        users.forEach(u => { if(u.username !== myName) list.innerHTML += `<div class="chat-item" onclick="startChat('${u.username}', '${u.avatar}')"><img src="${u.avatar}" class="avatar"><strong>${u.username}</strong></div>`; });
    }
    async function startChat(user, av) {
        targetUser = user; document.getElementById('chattingWithName').innerText = user; document.getElementById('targetAv').src = av;
        document.getElementById('chat-header').style.display = 'flex'; document.getElementById('inputArea').style.display = 'flex';
        const res = await fetch(`/get-messages?withUser=${user}`); const history = await res.json();
        const box = document.getElementById('messages'); box.innerHTML = ''; history.forEach(m => addBubble(m));
    }
    async function showUserInfo() {
        const res = await fetch(`/user-info?username=${targetUser}`); const d = await res.json();
        document.getElementById('infoName').innerText = d.username; document.getElementById('infoAv').src = d.avatar;
        document.getElementById('infoDate').innerText = "Joined: " + new Date(d.created_at).toLocaleDateString();
        document.getElementById('infoModal').style.display = 'block'; document.getElementById('modalOverlay').style.display = 'block';
    }
    function closeModal() { document.getElementById('infoModal').style.display = 'none'; document.getElementById('modalOverlay').style.display = 'none'; }
    function addBubble(data) {
        const div = document.createElement('div'); div.className = `bubble ${data.sender === myName ? 'sent' : 'received'}`;
        if (data.fileData) {
            if (data.fileData.startsWith('data:image')) div.innerHTML = `<img src="${data.fileData}" style="max-width:100%; border-radius:8px; display:block;">`;
            else div.innerHTML = `ðŸ“„ <a href="${data.fileData}" download="${data.fileName}">${data.fileName}</a>`;
        } else div.innerText = data.content || "";
        document.getElementById('messages').appendChild(div); document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
    function sendMsg() { const m = document.getElementById('msgInput').value; if(m && targetUser) { socket.emit('private-message', { to: targetUser, from: myName, msg: m }); document.getElementById('msgInput').value = ''; } }
    function uploadFile() {
        const file = document.getElementById('fIn').files[0]; const reader = new FileReader();
        reader.onload = (e) => socket.emit('file-upload', { to: targetUser, from: myName, fileName: file.name, fileData: e.target.result });
        reader.readAsDataURL(file);
    }
    socket.on('new-private-msg', (d) => { if((d.sender === targetUser && d.receiver === myName) || (d.sender === myName && d.receiver === targetUser)) addBubble(d); });
    socket.on('new-file', (d) => { if((d.sender === targetUser && d.receiver === myName) || (d.sender === myName && d.receiver === targetUser)) addBubble(d); });
    window.onclick = (e) => { if (!e.target.matches('.menu-btn')) document.getElementById('mainMenu').style.display = 'none'; }
</script>
</body>
</html>